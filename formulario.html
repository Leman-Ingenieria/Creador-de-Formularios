<!DOCTYPE html>
<html>
<head>
  <title>Responder Formulario</title>
  <style>
    body {
      font-family: sans-serif;
      padding: 20px;
      max-width: 700px;
      margin: auto;
    }
    label {
      display: block;
      margin-top: 15px;
      font-weight: bold;
    }
    input, select, textarea {
      width: 100%;
      padding: 8px;
      margin-top: 5px;
      box-sizing: border-box;
    }
    button {
      margin-top: 20px;
      padding: 10px 15px;
      cursor: pointer;
    }
    .moneda::before {
      content: "$";
      margin-right: 5px;
    }
  </style>
</head>
<body>
  <h2>Responder Formulario</h2>

  <form id="formulario" style="display:none;">
    <div id="campos"></div>
    <button type="submit">Enviar respuesta</button>
  </form>

  <script>
    const urlWebApp = "https://script.google.com/macros/s/AKfycbxs4YjQT2QHS3quSyVQLbbv57RIZcI8C2PRcMQoDAs1qSmX9CdmMRp5K6YgUyjf9dqV/exec";

    // Obtener el id del formulario desde la url
    function getQueryParam(param) {
      const params = new URLSearchParams(window.location.search);
      return params.get(param);
    }

    async function cargarFormulario(id) {
      try {
        const res = await fetch(urlWebApp, {
          method: "POST",
          body: JSON.stringify({ action: "getFormulario", id })
        });
        const json = await res.json();
        if (json.status !== "ok") {
          alert("Formulario no encontrado.");
          return;
        }
        const estructura = json.estructura;
        const camposDiv = document.getElementById("campos");
        camposDiv.innerHTML = "";

        estructura.forEach(campo => {
          const label = document.createElement("label");
          label.textContent = campo.label;

          let input;

          if (campo.type === "select") {
            input = document.createElement("select");
            (campo.options || []).forEach(opt => {
              const option = document.createElement("option");
              option.value = opt;
              option.textContent = opt;
              input.appendChild(option);
            });
          } else if (campo.type === "textarea") {
            input = document.createElement("textarea");
            input.rows = 4;
          } else if (campo.type === "number") {
            input = document.createElement("input");
            input.type = "number";
            if (campo.format === "entero") input.step = "1";
            else input.step = "0.01";
            if (campo.isCurrency) {
              input.classList.add("moneda");
              input.placeholder = "$";
            }
          } else {
            input = document.createElement("input");
            input.type = campo.type || "text";
          }

          input.name = campo.label;
          input.required = true;
          camposDiv.appendChild(label);
          camposDiv.appendChild(input);
        });

        document.getElementById("formulario").style.display = "block";
      } catch {
        alert("Error al cargar el formulario.");
      }
    }

    document.getElementById("formulario").addEventListener("submit", async (e) => {
      e.preventDefault();
      const id = getQueryParam("id");
      if (!id) {
        alert("No se especificó ningún formulario.");
        return;
      }

      const datos = {};
      const inputs = e.target.querySelectorAll("input, select, textarea");
      inputs.forEach(input => {
        datos[input.name] = input.value;
      });

      const payload = {
        action: "guardarRespuesta",
        id,
        datos
      };

      const res = await fetch(urlWebApp, {
        method: "POST",
        body: JSON.stringify(payload)
      });

      if (res.ok) {
        alert("Respuesta enviada correctamente. ¡Gracias!");
        e.target.reset();
        document.getElementById("formulario").style.display = "none";
      } else {
        alert("Error al enviar la respuesta.");
      }
    });

    // Al cargar la página, obtener id y cargar formulario
    window.onload = () => {
      const id = getQueryParam("id");
      if (!id) {
        alert("No se especificó ningún formulario.");
        return;
      }
      cargarFormulario(id);
    };
  </script>
</body>
</html>

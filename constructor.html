<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Constructor de Formularios</title>
  <style>
    body {
      margin: 0; font-family: Arial, sans-serif; height: 100vh; display: flex; background: #f0f0f0;
    }
    nav {
      width: 220px; background: #143757; color: white; display: flex; flex-direction: column; padding-top: 20px;
    }
    nav button, nav .submenu button {
      background: none; border: none; color: white; text-align: left; padding: 12px 20px; cursor: pointer; font-size: 16px;
    }
    nav button:hover, nav .submenu button:hover {
      background: #0e2a53;
    }
    nav .submenu {
      display: none; flex-direction: column;
      background: #1e4277;
    }
    nav .submenu.show {
      display: flex;
    }
    main {
      flex: 1; padding: 20px; overflow-y: auto;
      background: white; box-sizing: border-box;
    }
    h1 {
      text-align: center; margin-top: 0; margin-bottom: 20px;
    }
    .formulario-lista {
      margin-bottom: 15px;
    }
    select {
      padding: 6px; font-size: 16px; width: 100%; max-width: 400px;
    }
    .botones-accion {
      margin-top: 10px;
    }
    .botones-accion button {
      margin-right: 10px; padding: 6px 12px; font-size: 14px; cursor: pointer;
    }
    .nuevo-formulario {
      max-width: 400px;
      border: 1px solid #ccc;
      padding: 15px;
      border-radius: 6px;
    }
    .nuevo-formulario label {
      display: block;
      margin-top: 10px;
      font-weight: bold;
    }
    .nuevo-formulario input, .nuevo-formulario select, .nuevo-formulario textarea {
      width: 100%;
      padding: 8px;
      box-sizing: border-box;
      margin-top: 5px;
    }
    .campo {
      border-bottom: 1px solid #ddd;
      padding: 8px 0;
    }
    .campo strong {
      font-weight: bold;
    }
    .mensaje {
      font-style: italic;
      color: #666;
      margin-top: 15px;
    }
    /* Scroll para main */
    main::-webkit-scrollbar {
      width: 8px;
    }
    main::-webkit-scrollbar-track {
      background: #f0f0f0;
    }
    main::-webkit-scrollbar-thumb {
      background-color: #888;
      border-radius: 10px;
    }
  </style>
</head>
<body>

  <nav>
    <button id="btnFormularios">Formularios ‚ñæ</button>
    <div id="submenuFormularios" class="submenu">
      <button id="btnVerEditar">Ver/Editar</button>
      <button id="btnNuevoFormulario">Nuevo Formulario</button>
    </div>
    <!-- Aqu√≠ pod√©s agregar m√°s men√∫s como Configuraci√≥n si quer√©s -->
  </nav>

  <main>
    <h1>Entorno de Trabajo</h1>

    <div id="contenido">

      <!-- Contenido din√°mico se inserta aqu√≠ -->

    </div>
  </main>

  <script>
    const urlWebApp = "https://script.google.com/macros/s/AKfycbxs4YjQT2QHS3quSyVQLbbv57RIZcI8C2PRcMQoDAs1qSmX9CdmMRp5K6YgUyjf9dqV/exec";

    // Variables globales
    let formularios = [];
    let formularioSeleccionado = null;

    // Men√∫ desplegable
    document.getElementById("btnFormularios").addEventListener("click", () => {
      const submenu = document.getElementById("submenuFormularios");
      submenu.classList.toggle("show");
    });

    // Bot√≥n Ver/Editar
    document.getElementById("btnVerEditar").addEventListener("click", () => {
      mostrarListaFormularios();
    });

    // Bot√≥n Nuevo Formulario
    document.getElementById("btnNuevoFormulario").addEventListener("click", () => {
      mostrarFormularioNuevo();
    });

    // Funci√≥n para obtener todos los formularios
    async function obtenerFormularios() {
      try {
        const res = await fetch(urlWebApp + "?action=getFormularios");
        const json = await res.json();
        if (json.status === "ok") {
          formularios = json.formularios.sort((a, b) => a.titulo.localeCompare(b.titulo));
          return formularios;
        } else {
          formularios = [];
          return [];
        }
      } catch (e) {
        console.error("Error al obtener formularios:", e);
        formularios = [];
        return [];
      }
    }

    // Mostrar lista desplegable para seleccionar formulario a ver/editar/eliminar
    async function mostrarListaFormularios() {
      formularioSeleccionado = null;
      const contenido = document.getElementById("contenido");
      contenido.innerHTML = "<h2>Seleccionar formulario</h2>";

      const formList = document.createElement("div");
      formList.className = "formulario-lista";

      const select = document.createElement("select");
      select.id = "selectFormularios";

      const formulariosList = await obtenerFormularios();

      if (formulariosList.length === 0) {
        const noFormMsg = document.createElement("p");
        noFormMsg.className = "mensaje";
        noFormMsg.textContent = "No existen formularios. Crea el primero.";
        contenido.appendChild(noFormMsg);
        return;
      }

      // Opciones select
      formulariosList.forEach(f => {
        const option = document.createElement("option");
        option.value = f.id;
        option.textContent = f.titulo;
        select.appendChild(option);
      });

      formList.appendChild(select);
      contenido.appendChild(formList);

      // Botones Ver, Editar, Eliminar
      const divBotones = document.createElement("div");
      divBotones.className = "botones-accion";

      const btnVer = document.createElement("button");
      btnVer.textContent = "Ver";
      btnVer.onclick = () => {
        const id = select.value;
        const titulo = formularios.find(f => f.id === id)?.titulo || "Formulario";
        window.open(`responder.html?form=${encodeURIComponent(titulo.replace(/\s+/g, "-"))}`, "_blank");
      };

      const btnEditar = document.createElement("button");
      btnEditar.textContent = "Editar";
      btnEditar.onclick = () => {
        const id = select.value;
        mostrarFormularioEditar(id);
      };

      const btnEliminar = document.createElement("button");
      btnEliminar.textContent = "Eliminar";
      btnEliminar.onclick = () => {
        const id = select.value;
        confirmarEliminar(id);
      };

      divBotones.appendChild(btnVer);
      divBotones.appendChild(btnEditar);
      divBotones.appendChild(btnEliminar);

      contenido.appendChild(divBotones);

      // Guardar formulario seleccionado
      select.addEventListener("change", (e) => {
        formularioSeleccionado = e.target.value;
      });
      formularioSeleccionado = select.value;
    }

    // Mostrar formulario para crear uno nuevo
    function mostrarFormularioNuevo() {
      formularioSeleccionado = null;
      const contenido = document.getElementById("contenido");
      contenido.innerHTML = `
        <h2>Crear nuevo formulario</h2>
        <label>T√≠tulo del formulario:
          <input type="text" id="tituloForm" />
        </label>

        <div id="campos"></div>

        <button id="btnAgregarCampo">+ Agregar campo</button>
        <button id="btnGuardarFormulario">üíæ Guardar formulario</button>

        <!-- Modal para agregar campo -->
        <div id="modal" style="display:none; background:#fff; border:1px solid #ccc; padding:20px; margin-top:20px;">
          <h3>Nuevo campo</h3>
          <label>Etiqueta del campo:
            <input id="nuevoLabel" />
          </label>

          <label>Tipo de campo:
            <select id="nuevoTipo" onchange="mostrarConfiguracionesTipo()">
              <option value="">Seleccionar tipo</option>
              <option value="text">Texto</option>
              <option value="number">N√∫mero</option>
              <option value="select">Lista desplegable</option>
              <option value="textarea">√Årea de texto</option>
              <option value="nuevo">+ Agregar nuevo tipo personalizado</option>
            </select>
          </label>

          <div id="configTipo" class="seccion-opciones"></div>

          <button id="btnConfirmarCampo">‚úî Confirmar campo</button>
          <button id="btnCerrarModal">Cancelar</button>
        </div>
      `;

      // Variables y funciones para el formulario nuevo
      const campos = [];

      function mostrarConfiguracionesTipo() {
        const tipo = document.getElementById("nuevoTipo").value;
        const configDiv = document.getElementById("configTipo");
        configDiv.innerHTML = "";

        if (tipo === "select") {
          configDiv.innerHTML = `
            <label>Opciones (una por l√≠nea):</label>
            <textarea id="opcionesSelect" rows="4"></textarea>
          `;
        }

        if (tipo === "number") {
          configDiv.innerHTML = `
            <div class="campo-opciones">
              <label><input type="checkbox" id="esMoneda" /> ¬øEs moneda?</label>
              <label>Formato num√©rico:
                <select id="formatoNumero">
                  <option value="entero">Entero</option>
                  <option value="decimal">Decimal</option>
                </select>
              </label>
            </div>
          `;
        }

        if (tipo === "nuevo") {
          const nuevo = prompt("Ingres√° el nuevo tipo personalizado:");
          if (nuevo && nuevo.trim() !== "") {
            const select = document.getElementById("nuevoTipo");
            const opt = document.createElement("option");
            opt.value = nuevo.trim();
            opt.textContent = nuevo.trim();
            select.appendChild(opt);
            select.value = nuevo.trim();
          } else {
            document.getElementById("nuevoTipo").value = "";
          }
        }
      }

      function renderCampos() {
        const div = document.getElementById("campos");
        div.innerHTML = "";
        campos.forEach((c, i) => {
          const d = document.createElement("div");
          d.className = "campo";
          d.innerHTML = `
            <strong>${i + 1}. ${c.label}</strong> (${c.type}) 
            ${c.options ? `<br><em>Opciones:</em> ${c.options.join(", ")}` : ""}
            ${c.type === "number" ? `<br><em>${c.isCurrency ? "Moneda" : "N√∫mero"}, ${c.format}</em>` : ""}
            <button data-index="${i}" class="btnEliminarCampo" style="margin-left: 10px; font-size: 12px;">Eliminar</button>
          `;
          div.appendChild(d);
        });

        // Agregar event listener para eliminar campo
        document.querySelectorAll(".btnEliminarCampo").forEach(btn => {
          btn.onclick = (e) => {
            const idx = parseInt(e.target.getAttribute("data-index"));
            campos.splice(idx, 1);
            renderCampos();
          };
        });
      }

      // Agregar campo nuevo
      document.getElementById("btnAgregarCampo").onclick = () => {
        document.getElementById("modal").style.display = "block";
        document.getElementById("nuevoLabel").value = "";
        document.getElementById("nuevoTipo").value = "";
        document.getElementById("configTipo").innerHTML = "";
      };

      document.getElementById("nuevoTipo").addEventListener("change", mostrarConfiguracionesTipo);

      document.getElementById("btnConfirmarCampo").onclick = () => {
        const label = document.getElementById("nuevoLabel").value.trim();
        const tipo = document.getElementById("nuevoTipo").value;

        if (!label || !tipo) {
          alert("Complet√° todos los campos.");
          return;
        }

        const nuevoCampo = { label, type: tipo };

        if (tipo === "select") {
          const opciones = document.getElementById("opcionesSelect").value
            .split("\n")
            .map(o => o.trim())
            .filter(o => o !== "");
          nuevoCampo.options = opciones;
        }

        if (tipo === "number") {
          nuevoCampo.isCurrency = document.getElementById("esMoneda").checked;
          nuevoCampo.format = document.getElementById("formatoNumero").value;
        }

        campos.push(nuevoCampo);
        renderCampos();
        document.getElementById("modal").style.display = "none";
      };

      document.getElementById("btnCerrarModal").onclick = () => {
        document.getElementById("modal").style.display = "none";
      };

      // Guardar formulario
      document.getElementById("btnGuardarFormulario").onclick = async () => {
        const titulo = document.getElementById("tituloForm").value.trim();
        if (!titulo) {
          alert("El formulario debe tener un t√≠tulo.");
          return;
        }
        if (campos.length === 0) {
          alert("Agreg√° al menos un campo.");
          return;
        }

        try {
          const res = await fetch(urlWebApp, {
            method: "POST",
            body: JSON.stringify({
              action: "guardarFormulario",
              titulo,
              estructura: campos
            }),
          });
          const json = await res.json();
          if (json.status === "ok") {
            alert("Formulario guardado con √©xito.");
            mostrarListaFormularios();
          } else {
            alert("Error al guardar formulario.");
          }
        } catch (e) {
          alert("Error al guardar formulario.");
          console.error(e);
        }
      };
    }

    // Mostrar formulario para editar uno existente
    async function mostrarFormularioEditar(id) {
      const contenido = document.getElementById("contenido");
      contenido.innerHTML = "<h2>Editar formulario</h2>";

      try {
        const res = await fetch(urlWebApp + "?action=getFormulario&id=" + encodeURIComponent(id));
        const json = await res.json();
        if (json.status !== "ok") {
          contenido.innerHTML += "<p>No se pudo cargar el formulario.</p>";
          return;
        }

        const formulario = json;
        let estructura = formulario.estructura || [];
        if (typeof estructura === "string") estructura = JSON.parse(estructura);

        let campos = estructura.slice();

        contenido.innerHTML += `
          <label>T√≠tulo del formulario:
            <input type="text" id="tituloFormEditar" value="${formulario.titulo}" />
          </label>
          <div id="camposEditar"></div>
          <button id="btnAgregarCampoEditar">+ Agregar campo</button>
          <button id="btnGuardarEdicion">Guardar cambios</button>
          <button id="btnCancelarEdicion">Cancelar</button>

          <!-- Modal editar campo -->
          <div id="modalEditarCampo" style="display:none; background:#fff; border:1px solid #ccc; padding:20px; margin-top:20px;">
            <h3>Editar campo</h3>
            <label>Etiqueta del campo:
              <input id="editarLabel" />
            </label>

            <label>Tipo de campo:
              <select id="editarTipo" onchange="mostrarConfiguracionesTipoEditar()">
                <option value="">Seleccionar tipo</option>
                <option value="text">Texto</option>
                <option value="number">N√∫mero</option>
                <option value="select">Lista desplegable</option>
                <option value="textarea">√Årea de texto</option>
                <option value="nuevo">+ Agregar nuevo tipo personalizado</option>
              </select>
            </label>

            <div id="configTipoEditar" class="seccion-opciones"></div>

            <button id="btnConfirmarCampoEditar">‚úî Confirmar campo</button>
            <button id="btnCerrarModalEditar">Cancelar</button>
          </div>
        `;

        function mostrarConfiguracionesTipoEditar() {
          const tipo = document.getElementById("editarTipo").value;
          const configDiv = document.getElementById("configTipoEditar");
          configDiv.innerHTML = "";

          if (tipo === "select") {
            configDiv.innerHTML = `
              <label>Opciones (una por l√≠nea):</label>
              <textarea id="opcionesSelectEditar" rows="4"></textarea>
            `;
          }

          if (tipo === "number") {
            configDiv.innerHTML = `
              <div class="campo-opciones">
                <label><input type="checkbox" id="esMonedaEditar" /> ¬øEs moneda?</label>
                <label>Formato num√©rico:
                  <select id="formatoNumeroEditar">
                    <option value="entero">Entero</option>
                    <option value="decimal">Decimal</option>
                  </select>
                </label>
              </div>
            `;
          }

          if (tipo === "nuevo") {
            const nuevo = prompt("Ingres√° el nuevo tipo personalizado:");
            if (nuevo && nuevo.trim() !== "") {
              const select = document.getElementById("editarTipo");
              const opt = document.createElement("option");
              opt.value = nuevo.trim();
              opt.textContent = nuevo.trim();
              select.appendChild(opt);
              select.value = nuevo.trim();
            } else {
              document.getElementById("editarTipo").value = "";
            }
          }
        }

        function renderCamposEditar() {
          const div

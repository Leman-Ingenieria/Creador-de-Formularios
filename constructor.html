<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Constructor de Formularios</title>
  <style>
    body {
      margin: 0;
      font-family: Arial, sans-serif;
      display: flex;
      height: 100vh;
      overflow: hidden;
    }
    nav {
      width: 230px;
      background-color: #005b96;
      color: white;
      display: flex;
      flex-direction: column;
      padding: 20px;
      box-sizing: border-box;
    }
    nav h2 {
      margin-top: 0;
      font-size: 18px;
      margin-bottom: 20px;
      text-align: center;
    }
    nav button {
      background: #0288d1;
      border: none;
      color: white;
      padding: 12px;
      margin-bottom: 10px;
      font-size: 16px;
      cursor: pointer;
      border-radius: 4px;
      transition: background 0.3s;
    }
    nav button:hover {
      background: #0277bd;
    }
    main {
      flex-grow: 1;
      padding: 20px;
      overflow-y: auto;
      box-sizing: border-box;
    }
    h1 {
      margin-top: 0;
      text-align: center;
    }
    label {
      display: block;
      margin: 10px 0 4px 0;
      font-weight: bold;
    }
    input[type="text"], select, textarea {
      width: 100%;
      padding: 8px;
      box-sizing: border-box;
      font-size: 14px;
    }
    textarea {
      resize: vertical;
    }
    .campo {
      border: 1px solid #ccc;
      padding: 10px;
      margin-bottom: 10px;
      position: relative;
      border-radius: 4px;
    }
    .campo .eliminar {
      position: absolute;
      top: 8px;
      right: 10px;
      cursor: pointer;
      color: red;
      font-weight: bold;
    }
    button#btnAgregarCampo {
      background: #00796b;
      color: white;
      border: none;
      padding: 10px 15px;
      font-size: 16px;
      cursor: pointer;
      border-radius: 4px;
      margin-top: 10px;
    }
    button#btnAgregarCampo:hover {
      background: #004d40;
    }
    button#btnGuardarCambios {
      background: #0288d1;
      color: white;
      border: none;
      padding: 12px 20px;
      font-size: 16px;
      cursor: pointer;
      border-radius: 4px;
      margin-top: 15px;
    }
    button#btnGuardarCambios:hover {
      background: #0277bd;
    }
    /* Para la sección de edición vía selector */
    #selectFormularios {
      width: 100%;
      padding: 8px;
      font-size: 16px;
      margin-bottom: 15px;
      box-sizing: border-box;
    }
    #formularioEdicion h3 {
      margin-top: 0;
    }
    /* Botones en edición */
    #formularioEdicion > div > div > button {
      cursor: pointer;
      border-radius: 4px;
      border: none;
      padding: 8px 15px;
      font-weight: bold;
      font-size: 14px;
    }
    #btnVer {
      background-color: #0288d1;
      color: white;
      margin-right: 10px;
    }
    #btnEliminar {
      background-color: #d9534f;
      color: white;
    }
  </style>
</head>
<body>
  <nav>
    <h2>Menú</h2>
    <button id="btnNuevo">Nuevo formulario</button>
    <button id="btnVerEditar">Ver/Editar formulario</button>
  </nav>

  <main>
    <h1 id="tituloMain">Entorno de trabajo</h1>
    <div id="contenido">
      <form id="formNuevoFormulario">
        <label for="titulo">Título del formulario:</label>
        <input type="text" id="titulo" required />

        <div id="campos"></div>

        <button type="button" id="btnAgregarCampo">Agregar campo</button>
        <br />
        <button type="submit" id="btnGuardar">Guardar formulario</button>
      </form>
    </div>
  </main>

  <script>
    const urlWebApp = "https://script.google.com/macros/s/AKfycbxs4YjQT2QHS3quSyVQLbbv57RIZcI8C2PRcMQoDAs1qSmX9CdmMRp5K6YgUyjf9dqV/exec";

    // Inicializar: mostrar nuevo formulario vacío
    let formularioActualId = null; // Para edición o null si es nuevo

    const contenido = document.getElementById("contenido");
    const tituloMain = document.getElementById("tituloMain");
    const formNuevo = document.getElementById("formNuevoFormulario");
    const camposDiv = document.getElementById("campos");

    // Eventos menú
    document.getElementById("btnNuevo").onclick = () => mostrarFormularioNuevo();
    document.getElementById("btnVerEditar").onclick = async () => {
      tituloMain.textContent = "Seleccionar formulario para editar";
      contenido.innerHTML = `
        <select id="selectFormularios"><option>Cargando...</option></select>
        <div id="formularioEdicion"></div>
      `;

      try {
        const res = await fetch(urlWebApp, {
          method: "POST",
          body: JSON.stringify({ action: "getFormularios" }),
          headers: { "Content-Type": "application/json" }
        });
        const data = await res.json();

        if (data.status !== "ok" || !data.formularios.length) {
          document.getElementById("selectFormularios").innerHTML = `<option>No hay formularios disponibles</option>`;
          return;
        }

        const select = document.getElementById("selectFormularios");
        select.innerHTML = `<option value="">-- Seleccione --</option>`;
        data.formularios.forEach(f => {
          const option = document.createElement("option");
          option.value = f.id;
          option.textContent = f.titulo;
          select.appendChild(option);
        });

        select.onchange = () => {
          if (!select.value) {
            document.getElementById("formularioEdicion").innerHTML = "";
            return;
          }
          cargarFormularioEdicion(select.value);
        };
      } catch (e) {
        contenido.innerHTML = `<p style="color:red;">Error al cargar formularios.</p>`;
        console.error(e);
      }
    };

    // Función mostrar formulario nuevo limpio
    function mostrarFormularioNuevo() {
      formularioActualId = null;
      tituloMain.textContent = "Entorno de trabajo";
      contenido.innerHTML = `
        <form id="formNuevoFormulario">
          <label for="titulo">Título del formulario:</label>
          <input type="text" id="titulo" required />

          <div id="campos"></div>

          <button type="button" id="btnAgregarCampo">Agregar campo</button>
          <br />
          <button type="submit" id="btnGuardar">Guardar formulario</button>
        </form>
      `;

      const formNuevoFormulario = document.getElementById("formNuevoFormulario");
      const camposDivNuevo = document.getElementById("campos");
      document.getElementById("btnAgregarCampo").onclick = () => agregarCampo(camposDivNuevo);

      formNuevoFormulario.onsubmit = async e => {
        e.preventDefault();
        const titulo = formNuevoFormulario.querySelector("#titulo").value.trim();
        if (!titulo) {
          alert("El título es obligatorio");
          return;
        }
        const campos = [];
        const camposDOM = camposDivNuevo.querySelectorAll(".campo");
        for (const campo of camposDOM) {
          const label = campo.querySelector(".nombreCampo").value.trim();
          const tipoSelect = campo.querySelector(".tipoCampo").value;
          if (!label || !tipoSelect) continue;

          const campoObj = { label };

          if (tipoSelect === "number_entero") {
            campoObj.type = "number";
            campoObj.format = "entero";
          } else if (tipoSelect === "number_decimal") {
            campoObj.type = "number";
            campoObj.format = "decimal";
          } else if (tipoSelect === "moneda") {
            campoObj.type = "number";
            campoObj.isCurrency = true;
          } else if (tipoSelect === "select") {
            campoObj.type = "select";
            const opcionesTextarea = campo.querySelector(".opcionesLista");
            campoObj.options = opcionesTextarea ? opcionesTextarea.value.split("\n").map(o => o.trim()).filter(o => o) : [];
          } else {
            campoObj.type = tipoSelect;
          }
          campos.push(campoObj);
        }

        try {
          const res = await fetch(urlWebApp, {
            method: "POST",
            body: JSON.stringify({
              action: "guardarFormulario",
              id: formularioActualId,
              titulo,
              estructura: campos
            }),
            headers: { "Content-Type": "application/json" }
          });
          const data = await res.json();

          if (data.status === "ok") {
            alert("Formulario guardado correctamente.");
            formularioActualId = data.id;
            mostrarFormularioNuevo(); // limpia para nuevo
          } else {
            alert("Error al guardar formulario.");
          }
        } catch (e) {
          alert("Error al conectar con el servidor.");
          console.error(e);
        }
      };

      // Botón agregar campo
      document.getElementById("btnAgregarCampo").onclick = () => agregarCampo(camposDivNuevo);

      // Arrancamos con un campo vacío
      agregarCampo(camposDivNuevo);
    }

    // Función para agregar campo en nuevo formulario
    function agregarCampo(container, campoData = null) {
      const div = document.createElement("div");
      div.className = "campo";

      div.innerHTML = `
        <span class="eliminar" title="Eliminar campo" style="position:absolute; top:5px; right:10px; cursor:pointer; color:red; font-weight:bold;">❌</span>
        <label>Nombre del campo:</label>
        <input type="text" class="nombreCampo" value="${campoData ? campoData.label : ""}" />
        <label>Tipo de campo:</label>
        <select class="tipoCampo">
          <option value="">Seleccionar tipo</option>
          <option value="text" ${campoData && campoData.type === "text" ? "selected" : ""}>Texto</option>
          <option value="number_entero" ${campoData && campoData.type === "number" && campoData.format === "entero" ? "selected" : ""}>Número entero</option>
          <option value="number_decimal" ${campoData && campoData.type === "number" && campoData.format === "decimal" ? "selected" : ""}>Número decimal</option>
          <option value="moneda" ${campoData && campoData.type === "number" && campoData.isCurrency ? "selected" : ""}>Moneda</option>
          <option value="select" ${campoData && campoData.type === "select" ? "selected" : ""}>Lista desplegable</option>
        </select>
        <div class="opcionesExtra"></div>
      `;

      container.appendChild(div);

      const selectTipo = div.querySelector(".tipoCampo");
      const opcionesDiv = div.querySelector(".opcionesExtra");

      function actualizarOpciones() {
        const tipo = selectTipo.value;
        opcionesDiv.innerHTML = "";
        if (tipo === "select") {
          const opcionesTexto = campoData && campoData.options ? campoData.options.join("\n") : "";
          opcionesDiv.innerHTML = `
            <label>Opciones (una por línea):</label>
            <textarea class="opcionesLista" rows="4">${opcionesTexto}</textarea>
          `;
        }
      }
      actualizarOpciones();

      selectTipo.onchange = actualizarOpciones;

      // Eliminar campo
      div.querySelector(".eliminar").onclick = () => div.remove();
    }

    // Función para cargar formulario para edición (modo Ver/Editar)
    async function cargarFormularioEdicion(id) {
      const formularioEdicionDiv = document.getElementById("formularioEdicion");
      formularioEdicionDiv.innerHTML = `<p>Cargando formulario...</p>`;

      try {
        const res = await fetch(urlWebApp, {
          method: "POST",
          body: JSON.stringify({ action: "getFormulario", id }),
          headers: { "Content-Type": "application/json" }
        });
        const data = await res.json();

        if (data.status !== "ok") {
          formularioEdicionDiv.innerHTML = `<p style="color:red;">No se pudo cargar el formulario</p>`;
          return;
        }

        const { titulo, estructura } = data;

        formularioEdicionDiv.innerHTML = `
          <div style="display:flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
            <h3>Editar Formulario: ${titulo}</h3>
            <div>
              <button id="btnVer" style="margin-right:10px;">Ver</button>
              <button id="btnEliminar" style="background-color:#d9534f; color:white;">Eliminar</button>
            </div>
          </div>
          <div id="edicionCampos"></div>
          <button id="btnGuardarCambios" style="margin-top:10px;">Guardar Cambios</button>
        `;

        const camposDiv = formularioEdicionDiv.querySelector("#edicionCampos");

        estructura.forEach((campo) => {
          agregarCampo(camposDiv, campo);
        });

        formularioEdicionDiv.querySelector("#btnVer").onclick = () => {
          window.open(`formulario.html?id=${id}`, "_blank");
        };

        formularioEdicionDiv.querySelector("#btnEliminar").onclick = () => {
          if (confirm(`¿Eliminar formulario "${titulo}"? Esta acción no se puede deshacer.`)) {
            eliminarFormulario(id);
          }
        };

        formularioEdicionDiv.querySelector("#btnGuardarCambios").onclick = () => {
          guardarCambios(id, titulo);
        };

      } catch (e) {
        formularioEdicionDiv.innerHTML = `<p style="color:red;">Error al cargar el formulario.</p>`;
        console.error(e);
      }
    }

    async function eliminarFormulario(id) {
      try {
        const res = await fetch(urlWebApp, {
          method: "POST",
          body: JSON.stringify({ action: "eliminarFormulario", id }),
          headers: { "Content-Type": "application/json" }
        });
        const data = await res.json();

        if (data.status === "ok") {
          alert("Formulario eliminado.");
          // Recargar lista
          document.getElementById("btnVerEditar").click();
          document.getElementById("formularioEdicion").innerHTML = "";
        } else {
          alert("Error al eliminar formulario.");
        }
      } catch (e) {
        alert("Error al conectar con el servidor.");
        console.error(e);
      }
    }

    async function guardarCambios(id, tituloOriginal) {
      const formularioEdicionDiv = document.getElementById("formularioEdicion");
      const camposDiv = formularioEdicionDiv.querySelector("#edicionCampos");
      const camposDOM = camposDiv.querySelectorAll(".campo");

      const estructura = [];
      let nuevoTitulo = tituloOriginal;

      // Intentamos sacar nuevo título del h3 (opcional para editar título)
      const h3 = formularioEdicionDiv.querySelector("h3");
      if (h3) {
        const texto = h3.textContent || "";
        const prefijo = "Editar Formulario:";
        if (texto.startsWith(prefijo)) {
          nuevoTitulo = prompt("Editar título del formulario:", texto.slice(prefijo.length).trim()) || nuevoTitulo;
          h3.textContent = `Editar Formulario: ${nuevoTitulo}`;
        }
      }

      for (const campo of camposDOM) {
        const label = campo.querySelector(".nombreCampo").value.trim();
        const tipoSelect = campo.querySelector(".tipoCampo").value;
        if (!label || !tipoSelect) continue;

        const campoObj = { label };

        if (tipoSelect === "number_entero") {
          campoObj.type = "number";
          campoObj.format = "entero";
        } else if (tipoSelect === "number_decimal") {
          campoObj.type = "number";
          campoObj.format = "decimal";
        } else if (tipoSelect === "moneda") {
          campoObj.type = "number";
          campoObj.isCurrency = true;
        } else if (tipoSelect === "select") {
          campoObj.type = "select";
          const opcionesTextarea = campo.querySelector(".opcionesLista");
          campoObj.options = opcionesTextarea ? opcionesTextarea.value.split("\n").map(o => o.trim()).filter(o => o) : [];
        } else {
          campoObj.type = tipoSelect;
        }

        estructura.push(campoObj);
      }

      try {
        const res = await fetch(urlWebApp, {
          method: "POST",
          body: JSON.stringify({
            action: "guardarFormulario",
            id,
            titulo: nuevoTitulo,
            estructura
          }),
          headers: { "Content-Type": "application/json" }
        });
        const data = await res.json();

        if (data.status === "ok") {
          alert("Cambios guardados correctamente.");
          // Recargar lista para reflejar título nuevo
          document.getElementById("btnVerEditar").click();
        } else {
          alert("Error al guardar formulario.");
        }
      } catch (e) {
        alert("Error al conectar con el servidor.");
        console.error(e);
      }
    }

    // Al cargar la página, mostramos formulario nuevo vacío
    mostrarFormularioNuevo();
  </script>
</body>
</html>

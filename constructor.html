<!DOCTYPE html>
<html>
<head>
  <title>Constructor de Formularios</title>
  <style>
    body {
      font-family: sans-serif;
      margin: 0;
      display: flex;
      height: 100vh;
    }
    nav {
      width: 220px;
      background: #143757;
      color: white;
      padding: 15px;
      box-sizing: border-box;
    }
    nav h2 {
      margin-top: 0;
      text-align: center;
      font-weight: 700;
      font-size: 1.4em;
    }
    nav ul {
      list-style: none;
      padding: 0;
      margin: 20px 0 0 0;
    }
    nav ul li {
      margin-bottom: 10px;
      cursor: pointer;
      padding: 8px;
      border-radius: 4px;
    }
    nav ul li:hover {
      background: #0f2f57;
    }
    nav ul li.active {
      background: #0a2243;
    }
    main {
      flex: 1;
      padding: 30px;
      box-sizing: border-box;
      overflow-y: auto;
    }
    h1 {
      text-align: center;
      margin-top: 0;
      color: #143757;
    }
    .hidden {
      display: none;
    }
    .campo {
      border-bottom: 1px solid #ccc;
      padding: 10px 0;
    }
    label {
      display: block;
      margin-top: 10px;
    }
    input, select, textarea, button {
      padding: 8px;
      margin-top: 5px;
      width: 100%;
      box-sizing: border-box;
    }
    .seccion-opciones {
      background: #f8f8f8;
      padding: 10px;
      margin-top: 10px;
      border-radius: 5px;
    }
    .campo-opciones label {
      font-size: 14px;
    }
    .btn-group button {
      margin-right: 10px;
      padding: 8px 12px;
      cursor: pointer;
    }
    .small-btn {
      padding: 5px 10px;
      font-size: 0.9em;
      margin-right: 5px;
    }
  </style>
</head>
<body>

  <nav>
    <h2>Men√∫</h2>
    <ul>
      <li id="menuFormularios" class="active">Formularios ‚ñæ
        <ul id="submenuFormularios" style="list-style:none; padding-left: 15px; margin-top:8px;">
          <li><button id="btnVerEditar">Ver/Editar</button></li>
          <li><button id="btnNuevoFormulario">Nuevo Formulario</button></li>
        </ul>
      </li>
      <li id="menuConfiguracion">Configuraci√≥n</li>
    </ul>
  </nav>

  <main>
    <h1 id="tituloPrincipal">Entorno de Trabajo</h1>

    <!-- Contenedor Ver/Editar -->
    <div id="contenedorVerEditar">
      <label for="selectFormularios">Seleccionar formulario:</label>
      <select id="selectFormularios" style="width: 100%;"></select>
      <div style="margin-top: 15px;">
        <button id="btnVer" class="small-btn">Ver</button>
        <button id="btnEditar" class="small-btn">Editar</button>
        <button id="btnEliminar" class="small-btn" style="background: #d9534f; color: white;">Eliminar</button>
      </div>
    </div>

    <!-- Contenedor Nuevo Formulario -->
    <div id="contenedorNuevoFormulario" class="hidden">
      <h2>Crear nuevo formulario</h2>
      <label>T√≠tulo del formulario:
        <input id="tituloForm" />
      </label>

      <div id="campos"></div>

      <button onclick="abrirModalCampo()">+ Agregar campo</button>
      <button onclick="guardarFormulario()">üíæ Guardar formulario</button>
    </div>

    <!-- Modal para agregar campo -->
    <div id="modal" style="display:none; background:#fff; border:1px solid #ccc; padding:20px; margin-top:20px;">
      <h3>Nuevo campo</h3>
      <label>Etiqueta del campo:
        <input id="nuevoLabel" />
      </label>

      <label>Tipo de campo:
        <select id="nuevoTipo" onchange="mostrarConfiguracionesTipo()">
          <option value="">Seleccionar tipo</option>
          <option value="text">Texto</option>
          <option value="number">N√∫mero</option>
          <option value="select">Lista desplegable</option>
          <option value="textarea">√Årea de texto</option>
          <option value="nuevo">+ Agregar nuevo tipo personalizado</option>
        </select>
      </label>

      <div id="configTipo" class="seccion-opciones"></div>

      <button onclick="confirmarCampo()">‚úî Confirmar campo</button>
      <button onclick="cerrarModal()">Cancelar</button>
    </div>

  </main>

  <script>
    const urlWebApp = "https://script.google.com/macros/s/AKfycbxs4YjQT2QHS3quSyVQLbbv57RIZcI8C2PRcMQoDAs1qSmX9CdmMRp5K6YgUyjf9dqV/exec";

    let campos = [];

    // Elementos
    const contenedorVerEditar = document.getElementById("contenedorVerEditar");
    const contenedorNuevoFormulario = document.getElementById("contenedorNuevoFormulario");
    const tituloPrincipal = document.getElementById("tituloPrincipal");
    const selectFormularios = document.getElementById("selectFormularios");
    const btnVer = document.getElementById("btnVer");
    const btnEditar = document.getElementById("btnEditar");
    const btnEliminar = document.getElementById("btnEliminar");
    const btnVerEditar = document.getElementById("btnVerEditar");
    const btnNuevoFormulario = document.getElementById("btnNuevoFormulario");
    const menuFormularios = document.getElementById("menuFormularios");
    const menuConfiguracion = document.getElementById("menuConfiguracion");

    // Inicializar
    window.onload = () => {
      mostrarVerEditar();
      cargarFormularios();
    };

    // Mostrar seccion Ver/Editar
    function mostrarVerEditar() {
      tituloPrincipal.textContent = "Entorno de Trabajo - Ver/Editar Formularios";
      contenedorVerEditar.classList.remove("hidden");
      contenedorNuevoFormulario.classList.add("hidden");
      cargarFormularios();
    }

    // Mostrar seccion Nuevo Formulario
    function mostrarNuevoFormulario() {
      tituloPrincipal.textContent = "Entorno de Trabajo - Nuevo Formulario";
      contenedorVerEditar.classList.add("hidden");
      contenedorNuevoFormulario.classList.remove("hidden");
      campos = [];
      renderCampos();
      document.getElementById("tituloForm").value = "";
    }

    // Eventos men√∫
    btnVerEditar.onclick = mostrarVerEditar;
    btnNuevoFormulario.onclick = mostrarNuevoFormulario;

    // Funci√≥n para cargar formularios desde la API
    async function cargarFormularios() {
      try {
        const res = await fetch(urlWebApp, {
          method: "POST",
          body: JSON.stringify({ action: "getFormularios" }),
        });
        const json = await res.json();
        selectFormularios.innerHTML = "";

        if (json.status === "ok" && json.formularios.length > 0) {
          json.formularios.forEach(f => {
            const option = document.createElement("option");
            option.value = f.id;
            option.textContent = f.titulo;
            selectFormularios.appendChild(option);
          });
        } else {
          const option = document.createElement("option");
          option.textContent = "No existen formularios. Crea el primero.";
          option.disabled = true;
          selectFormularios.appendChild(option);
        }
      } catch (error) {
        alert("Error al cargar formularios");
      }
    }

    // Botones Ver, Editar, Eliminar

    btnVer.onclick = () => {
      const id = selectFormularios.value;
      if (!id) return alert("Seleccion√° un formulario.");
      // Abrir nueva pesta√±a con url responder.html?id=ID_FORMULARIO
      window.open(`responder.html?id=${encodeURIComponent(id)}`, "_blank");
    };

    btnEditar.onclick = async () => {
      const id = selectFormularios.value;
      if (!id) return alert("Seleccion√° un formulario.");

      try {
        const res = await fetch(urlWebApp + "?action=getFormulario&id=" + encodeURIComponent(id));
        const json = await res.json();

        if (json.status !== "ok") return alert("No se encontr√≥ el formulario");

        // Cargar en modo edici√≥n en contenedorNuevoFormulario
        mostrarNuevoFormulario();
        document.getElementById("tituloForm").value = json.titulo;
        campos = json.estructura;
        renderCampos();

      } catch (error) {
        alert("Error al obtener formulario");
      }
    };

    btnEliminar.onclick = () => {
      const id = selectFormularios.value;
      if (!id) return alert("Seleccion√° un formulario.");

      if (confirm("¬øSeguro que quer√©s eliminar este formulario? Se eliminar√°n todos los datos.")) {
        fetch(urlWebApp, {
          method: "POST",
          body: JSON.stringify({ action: "eliminarFormulario", id }),
        })
        .then(r => r.json())
        .then(json => {
          if (json.status === "ok") {
            alert("Formulario eliminado correctamente.");
            cargarFormularios();
          } else {
            alert("Error al eliminar formulario.");
          }
        });
      }
    };

    // Funciones para agregar y renderizar campos

    function abrirModalCampo() {
      document.getElementById("modal").style.display = "block";
      document.getElementById("nuevoLabel").value = "";
      document.getElementById("nuevoTipo").value = "";
      document.getElementById("configTipo").innerHTML = "";
    }

    function cerrarModal() {
      document.getElementById("modal").style.display = "none";
    }

    function mostrarConfiguracionesTipo() {
      const tipo = document.getElementById("nuevoTipo").value;
      const configDiv = document.getElementById("configTipo");
      configDiv.innerHTML = "";

      if (tipo === "select") {
        configDiv.innerHTML = `
          <label>Opciones (una por l√≠nea):</label>
          <textarea id="opcionesSelect" rows="4"></textarea>
        `;
      }

      if (tipo === "number") {
        configDiv.innerHTML = `
          <div class="campo-opciones">
            <label><input type="checkbox" id="esMoneda" /> ¬øEs moneda?</label>
            <label>Formato num√©rico:
              <select id="formatoNumero">
                <option value="entero">Entero</option>
                <option value="decimal">Decimal</option>
              </select>
            </label>
          </div>
        `;
      }

      if (tipo === "nuevo") {
        const nuevo = prompt("Ingres√° el nuevo tipo personalizado:");
        if (nuevo && nuevo.trim() !== "") {
          const select = document.getElementById("nuevoTipo");
          const opt = document.createElement("option");
          opt.value = nuevo.trim();
          opt.textContent = nuevo.trim();
          select.appendChild(opt);
          select.value = nuevo.trim();
        } else {
          document.getElementById("nuevoTipo").value = "";
        }
      }
    }

    function confirmarCampo() {
      const label = document.getElementById("nuevoLabel").value.trim();
      let tipo = document.getElementById("nuevoTipo").value;

      if (!label || !tipo) {
        alert("Complet√° todos los campos.");
        return;
      }

      const nuevoCampo = { label, type: tipo };

      if (tipo === "select") {

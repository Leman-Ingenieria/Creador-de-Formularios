<!DOCTYPE html>
<html>
<head>
  <title>Constructor de Formularios</title>
  <style>
    body {
      margin: 0;
      font-family: sans-serif;
      background-color: #f4f4f4;
    }
    .container {
      display: flex;
      height: 100vh;
    }
    .sidebar {
      width: 220px;
      background-color: #143757;
      color: white;
      padding: 20px;
    }
    .sidebar h2 {
      font-size: 18px;
      margin-bottom: 10px;
    }
    .sidebar button {
      background: none;
      border: none;
      color: white;
      text-align: left;
      width: 100%;
      padding: 8px 0;
      cursor: pointer;
      font-size: 16px;
    }
    .submenu {
      margin-left: 10px;
      display: none;
      flex-direction: column;
    }
    .submenu button {
      font-size: 14px;
    }
    .main {
      flex: 1;
      padding: 30px;
    }
    h1 {
      text-align: center;
      color: #143757;
    }
    #campos {
      margin-top: 20px;
    }
    .campo {
      background: white;
      padding: 10px;
      margin: 5px 0;
      border-radius: 5px;
      border-left: 4px solid #143757;
    }
    .form-control {
      margin-top: 10px;
    }
    select, input, textarea, button {
      width: 100%;
      padding: 8px;
      margin-top: 5px;
      box-sizing: border-box;
    }
    .hidden {
      display: none;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="sidebar">
      <h2>Men√∫</h2>
      <button onclick="toggleSubmenu()">üìã Formularios</button>
      <div class="submenu" id="submenuFormularios">
        <button onclick="mostrarVista('verEditar')">Ver/Editar</button>
        <button onclick="mostrarVista('nuevo')">Nuevo</button>
      </div>
    </div>
    <div class="main">
      <h1>Entorno de Trabajo</h1>
      <div id="contenido"></div>
    </div>
  </div>

  <script>
    const urlWebApp = "https://script.google.com/macros/s/AKfycbxs4YjQT2QHS3quSyVQLbbv57RIZcI8C2PRcMQoDAs1qSmX9CdmMRp5K6YgUyjf9dqV/exec";
    let formularios = [];

    function toggleSubmenu() {
      const submenu = document.getElementById("submenuFormularios");
      submenu.style.display = submenu.style.display === "flex" ? "none" : "flex";
    }

    async function mostrarVista(vista) {
      const cont = document.getElementById("contenido");
      cont.innerHTML = "";

      if (vista === "verEditar") {
        const res = await fetch(urlWebApp + "?action=listarFormularios");
        const json = await res.json();
        formularios = json.formularios || [];

        if (formularios.length === 0) {
          cont.innerHTML = "<p>No hay formularios creados.</p>";
          return;
        }

        formularios.sort((a, b) => a.titulo.localeCompare(b.titulo));

        const select = document.createElement("select");
        select.id = "selectorForm";
        formularios.forEach(f => {
          const opt = document.createElement("option");
          opt.value = f.id;
          opt.textContent = f.titulo;
          select.appendChild(opt);
        });

        const btns = document.createElement("div");
        btns.innerHTML = `
          <button onclick="verFormulario()">üëÅ Ver</button>
          <button onclick="editarFormulario()">‚úèÔ∏è Editar</button>
          <button onclick="eliminarFormulario()">üóë Eliminar</button>
        `;

        cont.appendChild(select);
        cont.appendChild(btns);
      }

      if (vista === "nuevo") {
        cont.innerHTML = `
          <label>T√≠tulo del formulario:
            <input id="tituloForm">
          </label>
          <div id="campos"></div>
          <button onclick="agregarCampo()">+ Agregar campo</button>
          <button onclick="guardarFormulario()">üíæ Guardar formulario</button>
        `;
        campos = [];
        render();
      }
    }

    let campos = [];

    function agregarCampo() {
      const label = prompt("Nombre del campo:");
      if (!label) return;

      const tipo = prompt("Tipo (text, number, select, textarea):", "text");
      if (!tipo) return;

      let campo = { label, type: tipo };

      if (tipo === "select") {
        const opciones = prompt("Opciones separadas por coma:");
        campo.options = opciones.split(",").map(o => o.trim());
      }

      campos.push(campo);
      render();
    }

    function render() {
      const div = document.getElementById("campos");
      if (!div) return;
      div.innerHTML = "";
      campos.forEach((c, i) => {
        const d = document.createElement("div");
        d.className = "campo";
        d.innerHTML = `<strong>${i + 1}. ${c.label}</strong> (${c.type})`;
        div.appendChild(d);
      });
    }

    async function guardarFormulario() {
      const titulo = document.getElementById("tituloForm").value.trim();
      if (!titulo || campos.length === 0) {
        alert("Complet√° el t√≠tulo y agreg√° campos.");
        return;
      }

      const res = await fetch(urlWebApp, {
        method: "POST",
        body: JSON.stringify({
          action: "guardarFormulario",
          titulo: titulo,
          estructura: campos
        }),
      });

      const json = await res.json();
      if (json.status === "ok") {
        alert("Formulario guardado correctamente.");
        mostrarVista("nuevo");
      } else {
        alert("Error al guardar.");
      }
    }

    function verFormulario() {
      const selector = document.getElementById("selectorForm");
      const id = selector.value;
      window.open(`formulario.html?form=${id}`, "_blank");
    }

    function editarFormulario() {
      const selector = document.getElementById("selectorForm");
      const id = selector.value;
      window.location.href = `editar.html?form=${id}`;
    }

    async function eliminarFormulario() {
      const selector = document.getElementById("selectorForm");
      const id = selector.value;
      const nombre = selector.options[selector.selectedIndex].text;

      const confirmar = confirm(`¬øEliminar el formulario "${nombre}" y todos sus datos?`);
      if (!confirmar) return;

      const res = await fetch(urlWebApp, {
        method: "POST",
        body: JSON.stringify({
          action: "eliminarFormulario",
          id: id
        }),
      });

      const json = await res.json();
      if (json.status === "ok") {
        alert("Formulario eliminado.");
        mostrarVista("verEditar");
      } else {
        alert("Error al eliminar.");
      }
    }
  </script>
</body>
</html>

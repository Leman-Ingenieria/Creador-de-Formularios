<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Constructor de Formularios</title>
  <style>
    body {
      margin: 0; font-family: Arial, sans-serif; height: 100vh; display: flex; background: #f0f0f0;
    }
    nav {
      width: 220px; background: #143757; color: white; display: flex; flex-direction: column; padding-top: 20px;
    }
    nav button, nav .submenu button {
      background: none; border: none; color: white; text-align: left; padding: 12px 20px; cursor: pointer; font-size: 16px;
    }
    nav button:hover, nav .submenu button:hover {
      background: #0e2a53;
    }
    nav .submenu {
      display: none; flex-direction: column;
      background: #1e4277;
    }
    nav .submenu.show {
      display: flex;
    }
    main {
      flex: 1; padding: 20px; overflow-y: auto;
      background: white; box-sizing: border-box;
    }
    h1 {
      text-align: center; margin-top: 0; margin-bottom: 20px;
    }
    select {
      padding: 6px; font-size: 16px; width: 100%; max-width: 400px;
    }
    .botones-accion {
      margin-top: 10px;
    }
    .botones-accion button {
      margin-right: 6px; padding: 6px 10px; font-size: 13px; cursor: pointer;
      border-radius: 4px;
    }
    .btn-ver { background: #4CAF50; color: white; border: none; }
    .btn-editar { background: #2196F3; color: white; border: none; }
    .btn-eliminar { background: #f44336; color: white; border: none; }
    .campo {
      display: flex; align-items: center; margin-top: 8px;
      border-bottom: 1px solid #ddd; padding-bottom: 5px;
    }
    .campo input[type="text"], .campo select, .campo textarea {
      margin-right: 10px;
      padding: 6px;
      font-size: 14px;
      flex-grow: 1;
    }
    .campo textarea {
      resize: vertical;
      min-height: 40px;
      max-width: 300px;
    }
    .btnEliminarCampo {
      background: #c00; color: white; border: none; cursor: pointer; padding: 4px 8px; font-weight: bold; border-radius: 3px;
      flex-shrink: 0;
    }
    .mensaje {
      font-style: italic;
      color: #666;
      margin-top: 15px;
    }
  </style>
</head>
<body>

  <nav>
    <button id="btnFormularios">Formularios ‚ñæ</button>
    <div id="submenuFormularios" class="submenu">
      <button id="btnVerEditar">Ver/Editar</button>
      <button id="btnNuevoFormulario">Nuevo formulario</button>
    </div>
  </nav>

  <main>
    <h1>Entorno de Trabajo</h1>
    <div id="contenido"></div>
  </main>

  <script>
const urlWebApp = "https://script.google.com/macros/s/AKfycbxs4YjQT2QHS3quSyVQLbbv57RIZcI8C2PRcMQoDAs1qSmX9CdmMRp5K6YgUyjf9dqV/exec";

let formularios = [];
let formularioSeleccionado = null;

// Mostrar/ocultar submenu Formularios
document.getElementById("btnFormularios").addEventListener("click", () => {
  const submenu = document.getElementById("submenuFormularios");
  submenu.classList.toggle("show");
});

// Bot√≥n Ver/Editar
document.getElementById("btnVerEditar").addEventListener("click", () => {
  mostrarListaFormularios();
});

// Bot√≥n Nuevo formulario
document.getElementById("btnNuevoFormulario").addEventListener("click", () => {
  mostrarFormularioNuevo();
});

async function obtenerFormularios() {
  try {
    const res = await fetch(urlWebApp + "?action=getFormularios");
    const json = await res.json();
    if (json.status === "ok") {
      formularios = json.formularios.sort((a,b) => a.titulo.localeCompare(b.titulo));
      return formularios;
    } else {
      formularios = [];
      return [];
    }
  } catch(e) {
    console.error("Error al obtener formularios:", e);
    formularios = [];
    return [];
  }
}

// Mostrar lista para ver/editar/eliminar formularios
async function mostrarListaFormularios() {
  formularioSeleccionado = null;
  const contenido = document.getElementById("contenido");
  contenido.innerHTML = "<h2>Seleccionar formulario</h2>";

  const formulariosList = await obtenerFormularios();

  if (formulariosList.length === 0) {
    contenido.innerHTML += `<p class="mensaje">No existen formularios. Crea el primero.</p>`;
    return;
  }

  const select = document.createElement("select");
  select.id = "selectFormularios";
  select.style.maxWidth = "400px";

  formulariosList.forEach(f => {
    const option = document.createElement("option");
    option.value = f.id;
    option.textContent = f.titulo;
    select.appendChild(option);
  });

  contenido.appendChild(select);

  // Botones Ver, Editar, Eliminar
  const divBotones = document.createElement("div");
  divBotones.className = "botones-accion";

  const btnVer = document.createElement("button");
  btnVer.textContent = "Ver";
  btnVer.className = "btn-ver";
  btnVer.onclick = () => {
    const id = select.value;
    const titulo = formularios.find(f => f.id === id)?.titulo || "formulario";
    // Abrir responder.html con el par√°metro del t√≠tulo formateado
    window.open(`responder.html?form=${encodeURIComponent(titulo.replace(/\s+/g, "-"))}`, "_blank");
  };

  const btnEditar = document.createElement("button");
  btnEditar.textContent = "Editar";
  btnEditar.className = "btn-editar";
  btnEditar.onclick = () => {
    const id = select.value;
    mostrarFormularioEditar(id);
  };

  const btnEliminar = document.createElement("button");
  btnEliminar.textContent = "Eliminar";
  btnEliminar.className = "btn-eliminar";
  btnEliminar.onclick = () => {
    const id = select.value;
    confirmarEliminar(id);
  };

  divBotones.appendChild(btnVer);
  divBotones.appendChild(btnEditar);
  divBotones.appendChild(btnEliminar);
  contenido.appendChild(divBotones);

  select.addEventListener("change", e => {
    formularioSeleccionado = e.target.value;
  });
  formularioSeleccionado = select.value;
}

// Mostrar formulario para crear uno nuevo
function mostrarFormularioNuevo() {
  formularioSeleccionado = null;
  const contenido = document.getElementById("contenido");
  contenido.innerHTML = `
    <h2>Crear nuevo formulario</h2>
    <label>T√≠tulo del formulario:<br>
      <input type="text" id="tituloForm" style="width: 300px; margin-bottom: 15px;" />
    </label>

    <div id="campos"></div>

    <button id="btnAgregarCampo" style="margin-top:10px;">+ Agregar campo</button>
    <button id="btnGuardarFormulario" style="margin-top:10px;">üíæ Guardar formulario</button>
  `;

  const campos = [];

  function renderCampos() {
    const div = document.getElementById("campos");
    div.innerHTML = "";
    campos.forEach((c, i) => {
      const campoDiv = document.createElement("div");
      campoDiv.className = "campo";

      campoDiv.innerHTML = `
        <input type="text" placeholder="Nombre del campo" value="${c.label}" data-index="${i}" class="input-label" />
        <select data-index="${i}" class="select-tipo">
          <option value="text" ${c.type === "text" ? "selected" : ""}>Texto</option>
          <option value="number_int" ${c.type === "number_int" ? "selected" : ""}>N√∫mero entero</option>
          <option value="number_dec" ${c.type === "number_dec" ? "selected" : ""}>N√∫mero decimal</option>
          <option value="moneda" ${c.type === "moneda" ? "selected" : ""}>Moneda</option>
          <option value="select" ${c.type === "select" ? "selected" : ""}>Lista desplegable</option>
        </select>
        <textarea data-index="${i}" class="textarea-opciones" placeholder="Opciones (una por l√≠nea)" style="display:none;"></textarea>
        <button class="btnEliminarCampo" data-index="${i}">X</button>
      `;

      div.appendChild(campoDiv);

      // Mostrar textarea solo si es select
      const selectTipo = campoDiv.querySelector(".select-tipo");
      const textareaOpciones = campoDiv.querySelector(".textarea-opciones");
      if(c.type === "select") {
        textareaOpciones.style.display = "block";
        textareaOpciones.value = c.options ? c.options.join("\n") : "";
      } else {
        textareaOpciones.style.display = "none";
      }

      // Actualizar al cambiar tipo
      selectTipo.addEventListener("change", (e) => {
        const idx = parseInt(e.target.dataset.index);
        campos[idx].type = e.target.value;
        if(e.target.value === "select") {
          campos[idx].options = campos[idx].options || [];
        } else {
          delete campos[idx].options;
        }
        renderCampos();
      });

      // Actualizar label
      campoDiv.querySelector(".input-label").addEventListener("input", (e) => {
        const idx = parseInt(e.target.dataset.index);
        campos[idx].label = e.target.value;
      });

      // Actualizar opciones textarea
      textareaOpciones.addEventListener("input", (e) => {
        const idx = parseInt(e.target.dataset.index);
        campos[idx].options = e.target.value.split("\n").map(opt => opt.trim()).filter(opt => opt !== "");
      });

      // Bot√≥n eliminar campo
      campoDiv.querySelector(".btnEliminarCampo").addEventListener("click", (e) => {
        const idx = parseInt(e.target.dataset.index);
        campos.splice(idx,1);
        renderCampos();
      });
    });
  }

  // Inicial render
  renderCampos();

  // Bot√≥n agregar campo
  document.getElementById("btnAgregarCampo").onclick = () => {
    campos.push({ label: "", type: "text" });
    renderCampos();
  };

  // Bot√≥n guardar formulario
  document.getElementById("btnGuardarFormulario").onclick = async () => {
    const titulo = document.getElementById("tituloForm").value.trim();
    if(!titulo) {
      alert("El formulario debe tener un t√≠tulo");
      return;
    }
    if(campos.length === 0) {
      alert("Agreg√° al menos un campo");
      return;
    }
    // Validar que ning√∫n campo tenga etiqueta vac√≠a
    for(let c of campos) {
      if(!c.label || c.label.trim() === "") {
        alert("Todos los campos deben tener un nombre");
        return;
      }
    }

    try {
      const res = await fetch(urlWebApp, {
        method: "POST",
        body: JSON.stringify({
          action: "guardarFormulario",
          titulo,
          estructura: campos
        }),
      });
      const json = await res.json();
      if(json.status === "ok") {
        alert("Formulario guardado con √©xito.");
        mostrarListaFormularios();
      } else {
        alert("Error al guardar formulario.");
      }
    } catch(e) {
      alert("Error al guardar formulario.");
      console.error(e);
    }
  };
}

// Mostrar formulario para editar
async function mostrarFormularioEditar(id) {
  const contenido = document.getElementById("contenido");
  contenido.innerHTML = "<h2>Editar formulario</h2>";

  try {
    const res = await fetch(urlWebApp + "?action=getFormulario&id=" + encodeURIComponent(id));
    const json = await res.json();
    if(json.status !== "ok") {
      contenido.innerHTML += "<p>No se pudo cargar el formulario.</p>";
      return;
    }

    cargarFormularioParaEditar(id, json.titulo, json.estructura);
  } catch(e) {
    contenido.innerHTML += "<p>Error al cargar formulario.</p>";
  }
}

function cargarFormularioParaEditar(id, titulo, estructura) {
  const contenido = document.getElementById("contenido");
  contenido.innerHTML = `
    <label>T√≠tulo del formulario:<br>
      <input type="text" id="tituloFormEditar" style="width: 300px; margin-bottom: 15px;" />
    </label>

    <div id="camposEditar"></div>

    <button id="btnAgregarCampoEditar" style="margin-top:10px;">+ Agregar campo</button>
    <button id="btnGuardarEdicion" style="margin-top:10px;">Guardar cambios</button>
    <button id="btnCancelarEdicion" style="margin-top:10px;">Cancelar</button>
  `;

  const campos = estructura.slice();

  function renderCamposEditar() {
    const div = document.getElementById("camposEditar");
    div.innerHTML = "";
    campos.forEach((c, i) => {
      const
<script>
  function getQueryParam(param) {
    const urlParams = new URLSearchParams(window.location.search);
    return urlParams.get(param);
  }

  window.onload = async () => {
    const editId = getQueryParam('edit');
    if (editId) {
      try {
        const res = await fetch(urlWebApp + "?action=getFormulario&id=" + encodeURIComponent(editId));
        const json = await res.json();
        if (json.status === "ok") {
          cargarFormularioParaEditar(editId, json.titulo, json.estructura);
        } else {
          alert("No se encontr√≥ el formulario para editar");
        }
      } catch (e) {
        console.error(e);
        alert("Error al cargar el formulario para editar");
      }
    }
  };
</script>

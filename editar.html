<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Editar Formularios</title>
  <style>
    body {
      margin: 0; font-family: Arial, sans-serif; height: 100vh; display: flex; background: #f0f0f0;
    }
    nav {
      width: 220px; background: #143757; color: white; display: flex; flex-direction: column; padding-top: 20px; overflow-y: auto;
    }
    nav .formulario-item {
      padding: 10px 15px; border-bottom: 1px solid #1e4277; cursor: pointer; font-weight: bold; color: white; display: flex; justify-content: space-between; align-items: center;
    }
    nav .formulario-item:hover {
      background: #0e2a53;
    }
    nav .opciones {
      background: #1e4277; display: none; flex-direction: column; margin-top: 5px;
    }
    nav .opciones button {
      background: none; border: none; color: white; padding: 8px 15px; text-align: left; cursor: pointer;
    }
    nav .opciones button:hover {
      background: #0e2a53;
    }
    main {
      flex: 1; padding: 20px; overflow-y: auto; background: white;
    }
    h1 {
      text-align: center; margin-top: 0; margin-bottom: 20px;
    }
  </style>
</head>
<body>
  <nav id="menuFormularios">
    <!-- Lista de formularios aquí -->
  </nav>
  <main>
    <h1>Editar Formulario</h1>
    <div id="editorContenido">
      <p>Seleccioná un formulario para editar.</p>
    </div>
  </main>

  <script>
    const urlWebApp = "https://script.google.com/macros/s/AKfycbxs4YjQT2QHS3quSyVQLbbv57RIZcI8C2PRcMQoDAs1qSmX9CdmMRp5K6YgUyjf9dqV/exec";

    async function cargarFormularios() {
      try {
        const res = await fetch(urlWebApp, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ action: "getFormularios" })
        });
        const json = await res.json();

        if (json.status !== "ok") {
          document.getElementById("menuFormularios").innerHTML = "<p style='color:white;padding:10px;'>Error al cargar formularios.</p>";
          return;
        }

        if (json.formularios.length === 0) {
          document.getElementById("menuFormularios").innerHTML = "<p style='color:white;padding:10px;'>No hay formularios creados.</p>";
          return;
        }

        const menu = document.getElementById("menuFormularios");
        menu.innerHTML = "";

        json.formularios.forEach(form => {
          if(form.titulo.toUpperCase() === "TÍTULO") return; // No mostrar si es solo título

          const item = document.createElement("div");
          item.className = "formulario-item";
          item.innerHTML = `
            <span>${form.titulo}</span>
            <button aria-label="Mostrar opciones">▼</button>
            <div class="opciones">
              <button onclick="verFormulario('${form.id}')">Ver</button>
              <button onclick="editarFormulario('${form.id}')">Editar</button>
              <button onclick="eliminarFormulario('${form.id}', '${form.titulo}')">Eliminar</button>
            </div>
          `;
          menu.appendChild(item);

          const btnFlecha = item.querySelector("button");
          const opciones = item.querySelector(".opciones");
          btnFlecha.addEventListener("click", () => {
            const visible = opciones.style.display === "flex";
            opciones.style.display = visible ? "none" : "flex";
          });
        });
      } catch (e) {
        console.error(e);
        document.getElementById("menuFormularios").innerHTML = "<p style='color:white;padding:10px;'>Error al conectar con el servidor.</p>";
      }
    }

    async function verFormulario(id) {
      window.open(`formulario.html?id=${id}`, "_blank");
    }

    async function editarFormulario(id) {
      const editor = document.getElementById("editorContenido");
      editor.innerHTML = "<p>Cargando formulario...</p>";

      try {
        const res = await fetch(urlWebApp, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ action: "getFormulario", id })
        });
        const json = await res.json();

        if (json.status !== "ok") {
          editor.innerHTML = "<p>Error al cargar formulario.</p>";
          return;
        }

        // Mostrar el formulario en modo edición simple (mostrar título y estructura JSON)
        editor.innerHTML = `
          <h2>Editar: ${json.titulo}</h2>
          <pre style="background:#eee; padding:10px; border-radius:5px; max-height: 400px; overflow: auto;">${JSON.stringify(json.estructura, null, 2)}</pre>
          <p><em>Edición avanzada próximamente.</em></p>
        `;
      } catch (e) {
        console.error(e);
        editor.innerHTML = "<p>Error al conectar con el servidor.</p>";
      }
    }

    async function eliminarFormulario(id, titulo) {
      if (!confirm(`¿Seguro que querés eliminar el formulario "${titulo}"? Esta acción no se puede deshacer.`)) return;

      try {
        const res = await fetch(urlWebApp, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ action: "eliminarFormulario", id })
        });
        const json = await res.json();

        if (json.status === "ok") {
          alert("Formulario eliminado correctamente.");
          cargarFormularios();
          document.getElementById("editorContenido").innerHTML = "<p>Seleccioná un formulario para editar.</p>";
        } else {
          alert("Error al eliminar el formulario.");
        }
      } catch (e) {
        console.error(e);
        alert("Error al conectar con el servidor.");
      }
    }

    // Carga inicial
    cargarFormularios();
  </script>
</body>
</html>

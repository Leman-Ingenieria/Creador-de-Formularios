<!DOCTYPE html>
<html>
<head>
  <title>Editar Formulario</title>
  <style>
    body {
      font-family: sans-serif;
      background-color: #143757;
      color: white;
      padding: 20px;
      max-width: 800px;
      margin: auto;
    }
    label { display: block; margin-top: 10px; }
    input, select, textarea, button {
      padding: 8px;
      margin-top: 5px;
      width: 100%;
      box-sizing: border-box;
    }
    .campo {
      background: #1f4d7a;
      padding: 10px;
      margin-top: 10px;
      border-radius: 5px;
    }
  </style>
</head>
<body>
  <h2>Editar formulario</h2>

  <label>Seleccionar formulario:
    <select id="formularioSelect">
      <option value="">Cargando...</option>
    </select>
  </label>

  <div id="editor" style="display:none;">
    <label>T√≠tulo del formulario:
      <input id="tituloForm" />
    </label>

    <div id="campos"></div>

    <button onclick="agregarCampo()">+ Agregar campo</button>
    <button onclick="guardarCambios()">üíæ Guardar cambios</button>
  </div>

  <script>
    const urlWebApp = "https://script.google.com/macros/s/AKfycbxs4YjQT2QHS3quSyVQLbbv57RIZcI8C2PRcMQoDAs1qSmX9CdmMRp5K6YgUyjf9dqV/exec";
    let campos = [];
    let formularioId = "";

    async function cargarFormularios() {
      const res = await fetch(urlWebApp);
      const json = await res.json();
      const select = document.getElementById("formularioSelect");
      select.innerHTML = `<option value="">Seleccionar</option>`;
      json.formularios.sort((a, b) => a.titulo.localeCompare(b.titulo)).forEach(f => {
        const opt = document.createElement("option");
        opt.value = f.id;
        opt.textContent = f.titulo;
        select.appendChild(opt);
      });
    }

    async function cargarFormulario(id) {
      const res = await fetch(urlWebApp + "?action=getFormulario&id=" + encodeURIComponent(id));
      const json = await res.json();
      if (json.status !== "ok") {
        alert("Error al cargar formulario");
        return;
      }
      formularioId = json.id;
      document.getElementById("tituloForm").value = json.titulo;
      campos = json.estructura;
      render();
      document.getElementById("editor").style.display = "block";
    }

    function render() {
      const cont = document.getElementById("campos");
      cont.innerHTML = "";
      campos.forEach((c, i) => {
        const div = document.createElement("div");
        div.className = "campo";
        div.innerHTML = `
          <label>Etiqueta:
            <input value="${c.label}" onchange="campos[${i}].label=this.value" />
          </label>
          <label>Tipo:
            <select onchange="cambiarTipoCampo(${i}, this.value)">
              <option value="text" ${c.type === "text" ? "selected" : ""}>Texto</option>
              <option value="number" ${c.type === "number" ? "selected" : ""}>N√∫mero</option>
              <option value="select" ${c.type === "select" ? "selected" : ""}>Lista desplegable</option>
              <option value="textarea" ${c.type === "textarea" ? "selected" : ""}>√Årea de texto</option>
            </select>
          </label>
          ${c.type === "select" ? `
            <label>Opciones (una por l√≠nea):
              <textarea onchange="actualizarOpciones(${i}, this.value)">${(c.options || []).join("\n")}</textarea>
            </label>` : ""}
          ${c.type === "number" ? `
            <label><input type="checkbox" ${c.isCurrency ? "checked" : ""} onchange="campos[${i}].isCurrency=this.checked" /> ¬øEs moneda?</label>
            <label>Formato:
              <select onchange="campos[${i}].format=this.value">
                <option value="entero" ${c.format === "entero" ? "selected" : ""}>Entero</option>
                <option value="decimal" ${c.format === "decimal" ? "selected" : ""}>Decimal</option>
              </select>
            </label>` : ""}
        `;
        cont.appendChild(div);
      });
    }

    function actualizarOpciones(i, val) {
      campos[i].options = val.split("\n").map(o => o.trim()).filter(o => o !== "");
    }

    function cambiarTipoCampo(i, tipo) {
      campos[i].type = tipo;
      if (tipo === "select" && !campos[i].options) campos[i].options = [];
      if (tipo === "number") {
        campos[i].isCurrency = false;
        campos[i].format = "entero";
      }
      render();
    }

    function agregarCampo() {
      campos.push({ label: "Nuevo campo", type: "text" });
      render();
    }

    async function guardarCambios() {
      const titulo = document.getElementById("tituloForm").value.trim();
      if (!titulo || campos.length === 0) {
        alert("Complet√° el t√≠tulo y los campos.");
        return;
      }

      const payload = {
        action: "actualizarFormulario",
        id: formularioId,
        titulo: titulo,
        estructura: campos
      };

      const res = await fetch(urlWebApp, {
        method: "POST",
        body: JSON.stringify(payload)
      });

      const json = await res.json();
      if (json.status === "ok") {
        alert("Formulario actualizado.");
        location.reload();
      } else {
        alert("Error al guardar cambios.");
      }
    }

    document.getElementById("formularioSelect").addEventListener("change", e => {
      if (e.target.value) cargarFormulario(e.target.value);
    });

    cargarFormularios();
  </script>
</body>
</html>

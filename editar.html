<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Editar Formularios</title>
  <style>
    body {
      margin: 0;
      font-family: Arial, sans-serif;
      display: flex;
      height: 100vh;
      background: #f0f0f0;
    }
    nav#listaFormularios {
      width: 280px;
      background-color: #143757;
      color: white;
      padding: 15px;
      overflow-y: auto;
      box-sizing: border-box;
    }
    nav#listaFormularios .formulario-item {
      padding: 10px 15px;
      margin-bottom: 8px;
      background: #1f4e8a;
      border-radius: 5px;
      cursor: pointer;
      font-weight: bold;
      position: relative;
      user-select: none;
    }
    nav#listaFormularios .formulario-item:hover {
      background: #3b6ab8;
    }
    nav#listaFormularios .flecha {
      position: absolute;
      right: 15px;
      top: 50%;
      transform: translateY(-50%);
      font-size: 14px;
      color: white;
      user-select: none;
      transition: transform 0.3s ease;
    }
    nav#listaFormularios .formulario-item.active .flecha {
      transform: translateY(-50%) rotate(180deg);
    }
    nav#listaFormularios .acciones {
      display: none;
      flex-direction: column;
      background: #2f5ca9;
      margin-top: 5px;
      border-radius: 0 0 5px 5px;
      padding: 5px 10px;
    }
    nav#listaFormularios .formulario-item.active .acciones {
      display: flex;
    }
    nav#listaFormularios .acciones button {
      background: #5190f1;
      border: none;
      color: white;
      padding: 6px 10px;
      margin: 3px 0;
      border-radius: 3px;
      font-weight: normal;
      cursor: pointer;
      text-align: left;
      transition: background-color 0.2s ease;
    }
    nav#listaFormularios .acciones button:hover {
      background: #7ab0f7;
    }
    main#editor {
      flex: 1;
      padding: 20px;
      overflow-y: auto;
      background: white;
      box-sizing: border-box;
    }
    main#editor h1 {
      margin-top: 0;
      margin-bottom: 15px;
      font-weight: normal;
      color: #143757;
      border-bottom: 2px solid #143757;
      padding-bottom: 5px;
    }
    #mensaje {
      color: red;
      font-weight: bold;
      margin-top: 10px;
    }
  </style>
</head>
<body>
  <nav id="listaFormularios">
    Cargando formularios...
  </nav>

  <main id="editor">
    <h1>Editar Formulario</h1>
    <div id="contenidoEditor">
      <p>Selecciona un formulario para editarlo.</p>
    </div>
    <div id="mensaje"></div>
  </main>

  <script>
    const urlWebApp = "https://script.google.com/macros/s/AKfycbxs4YjQT2QHS3quSyVQLbbv57RIZcI8C2PRcMQoDAs1qSmX9CdmMRp5K6YgUyjf9dqV/exec";
    const listaFormularios = document.getElementById("listaFormularios");
    const contenidoEditor = document.getElementById("contenidoEditor");
    const mensaje = document.getElementById("mensaje");

    async function cargarFormularios() {
      try {
        const res = await fetch(urlWebApp, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ action: "getFormularios" }),
        });
        const json = await res.json();

        if (json.status !== "ok") {
          listaFormularios.textContent = "Error al cargar formularios.";
          return;
        }

        if (json.formularios.length === 0) {
          listaFormularios.textContent = "No hay formularios creados.";
          return;
        }

        listaFormularios.innerHTML = "";

        json.formularios.forEach(form => {
          // Ocultar formularios sin t√≠tulo o con t√≠tulo "T√çTULO"
          if (!form.titulo || form.titulo.trim().toUpperCase() === "T√çTULO") return;

          const divItem = document.createElement("div");
          divItem.className = "formulario-item";
          divItem.innerHTML = `
            ${form.titulo}
            <span class="flecha">‚ñº</span>
            <div class="acciones">
              <button class="btnVer">Ver</button>
              <button class="btnEditar">Editar</button>
              <button class="btnEliminar">Eliminar</button>
            </div>
          `;

          // Botones funcionales
          divItem.querySelector(".btnVer").onclick = e => {
            e.stopPropagation();
            window.open(`formulario.html?id=${encodeURIComponent(form.id)}`, "_blank");
          };

          divItem.querySelector(".btnEditar").onclick = e => {
            e.stopPropagation();
            cargarFormularioParaEditar(form.id);
            // Abrir men√∫ de opciones (desplegar)
            cerrarTodos();
            divItem.classList.add("active");
          };

          divItem.querySelector(".btnEliminar").onclick = e => {
            e.stopPropagation();
            if (confirm(`¬øSeguro que quer√©s eliminar el formulario "${form.titulo}"?`)) {
              eliminarFormulario(form.id);
            }
          };

          // Toggle despliegue men√∫ opciones
          divItem.onclick = e => {
            // No toggle si clic en bot√≥n
            if (e.target.tagName === "BUTTON") return;

            const esActivo = divItem.classList.contains("active");
            cerrarTodos();
            if (!esActivo) {
              divItem.classList.add("active");
            }
          };

          listaFormularios.appendChild(divItem);
        });
      } catch (e) {
        console.error("Error:", e);
        listaFormularios.textContent = "Error al conectar con el servidor.";
      }
    }

    function cerrarTodos() {
      document.querySelectorAll(".formulario-item.active").forEach(item => item.classList.remove("active"));
    }

    async function cargarFormularioParaEditar(id) {
      mensaje.textContent = "";
      contenidoEditor.innerHTML = "<p>Cargando formulario...</p>";
      try {
        const res = await fetch(urlWebApp, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ action: "getFormulario", id }),
        });
        const json = await res.json();

        if (json.status !== "ok") {
          contenidoEditor.innerHTML = `<p>Error: ${json.message}</p>`;
          return;
        }

        mostrarFormularioEdicion(id, json.titulo, json.estructura);
      } catch (e) {
        console.error(e);
        contenidoEditor.innerHTML = `<p>Error al conectar con el servidor.</p>`;
      }
    }

    function mostrarFormularioEdicion(id, titulo, estructura) {
      // Guardamos el id para posibles futuros usos
      contenidoEditor.dataset.formId = id;

      // Mostrar t√≠tulo y estructura editable igual que en constructor.html
      // Esto es una versi√≥n simplificada: solo muestra los campos y permite editar label y tipo

      contenidoEditor.innerHTML = `
        <h2>${titulo}</h2>
        <label>T√≠tulo del formulario:</label>
        <input type="text" id="tituloEditar" value="${titulo}" style="width: 100%; padding:5px; margin-bottom:15px; box-sizing: border-box;">
        <div id="camposEditar"></div>
        <button id="btnAgregarCampoEditar">‚ûï Agregar campo</button>
        <button id="btnGuardarEditar">üíæ Guardar Cambios</button>
      `;

      const camposEditar = document.getElementById("camposEditar");

      estructura.forEach(campo => {
        const campoDiv = document.createElement("div");
        campoDiv.className = "campo";

        campoDiv.style = "border:1px solid #ccc; padding:10px; margin-bottom:10px; position:relative; border-radius:5px;";
        campoDiv.innerHTML = `
          <span class="eliminar" style="position:absolute; top:5px; right:10px; cursor:pointer; color:red; font-weight:bold;">‚ùå</span>
          <label>Nombre del campo:</label>
          <input type="text" class="nombreCampo" value="${campo.label}" style="width:100%; padding:5px; box-sizing: border-box;">
          <label>Tipo de campo:</label>
          <select class="tipoCampo" style="width:100%; padding:5px; margin-top:5px;">
            <option value="">Seleccionar tipo</option>
            <option value="text">Texto</option>
            <option value="number_entero">N√∫mero entero</option>
            <option value="number_decimal">N√∫mero decimal</option>
            <option value="moneda">Moneda</option>
            <option value="select">Lista desplegable</option>
          </select>
          <div class="opcionesExtra" style="margin-top:10px;"></div>
        `;

        // Ajustar select con el valor actual
        const tipoSelect = campoDiv.querySelector(".tipoCampo");
        if (campo.type === "number" && campo.format === "entero") {
          tipoSelect.value = "number_entero";
        } else if (campo.type === "number" && campo.format === "decimal") {
          tipoSelect.value = "number_decimal";
        } else if (campo.type === "number" && campo.isCurrency) {
          tipoSelect.value = "moneda";
        } else if (campo.type === "select") {
          tipoSelect.value = "select";
          // Agregar textarea con opciones
          const opcionesDiv = campoDiv.querySelector(".opcionesExtra");
          opcionesDiv.innerHTML = `<label>Opciones (una por l√≠nea):</label>
                                   <textarea class="opcionesLista" rows="4" style="width:100%; box-sizing:border-box;">${campo.options.join("\n")}</textarea>`;
        } else {
          tipoSelect.value = campo.type || "text";
        }

        // Evento para mostrar textarea si es select
        tipoSelect.onchange = function() {
          const opcionesDiv = campoDiv.querySelector(".opcionesExtra");
          if (this.value === "select") {
            opcionesDiv.innerHTML = `<label>Opciones (una por l√≠nea):</label>
                                     <textarea class="opcionesLista" rows="4" style="width:100%; box-sizing:border-box;"></textarea>`;
          } else {
            opcionesDiv.innerHTML = "";
          }
        };

        // Eliminar campo
        campoDiv.querySelector(".eliminar").onclick = () => campoDiv.remove();

        camposEditar.appendChild(campoDiv);
      });

      document.getElementById("btnAgregarCampoEditar").onclick = () => {
        const nuevoCampo = document.createElement("div");
        nuevoCampo.className = "campo";
        nuevoCampo.style = "border:1px solid #ccc; padding:10px; margin-bottom:10px; position:relative; border-radius:5px;";
        nuevoCampo.innerHTML = `
          <span class="eliminar" style="position:absolute; top:5px; right:10px; cursor:pointer; color:red; font-weight:bold;">‚ùå</span>
          <label>Nombre del campo:</label>
          <input type="text" class="nombreCampo" style="width:100%; padding:5px; box-sizing: border-box;">
          <label>Tipo de campo:</label>
          <select class="tipoCampo" style="width:100%; padding:5px; margin-top:5px;">
            <option value="">Seleccionar tipo</option>
            <option value="text">Texto</option>
            <option value="number_entero">N√∫mero entero</option>
            <option value="number_decimal">N√∫mero decimal</option>
            <option value="moneda">Moneda</option>
            <option value="select">Lista desplegable</option>
          </select>
          <div class="opcionesExtra" style="margin-top:10px;"></div>
        `;

        nuevoCampo.querySelector(".tipoCampo").onchange = function() {
          const opcionesDiv = nuevoCampo.querySelector(".opcionesExtra");
          if (this.value === "select") {
            opcionesDiv.innerHTML = `<label>Opciones (una por l√≠nea):</label>
                                     <textarea class="opcionesLista" rows="4" style="width:100%; box-sizing:border-box;"></textarea>`;
          } else {
            opcionesDiv.innerHTML = "";
          }
        };

        nuevoCampo.querySelector(".eliminar").onclick = () => nuevoCampo.remove();

        camposEditar.appendChild(nuevoCampo);
      };

      document.getElementById("btnGuardarEditar").onclick = async () => {
        mensaje.textContent = "";
        const nuevoTitulo = document.getElementById("tituloEditar").value.trim();
        if (!nuevoTitulo) {
          mensaje.textContent = "El t√≠tulo no puede estar vac√≠o.";
          return;
        }

        const campos = [];
        const camposDivs = camposEditar.querySelectorAll(".campo");

        for (const div of camposDivs) {
          const label = div.querySelector(".nombreCampo").value.trim();
          if (!label) {
            mensaje.textContent = "Todos los campos deben tener nombre.";
            return;
          }
          const tipoVal = div.querySelector(".tipoCampo").value;
          if (!tipoVal) {
            mensaje.textContent = "Todos los campos deben tener un tipo seleccionado.";
            return;
          }

          let campo = { label };

          switch (tipoVal) {
            case "number_entero":
              campo.type = "number";
              campo.format = "entero";
              break;
            case "number_decimal":
              campo.type = "number";
              campo.format = "decimal";
              break;
            case "moneda":
              campo.type = "number";
              campo.isCurrency = true;
              break;
            case "select":
              campo.type = "select";
              const opcionesText = div.querySelector(".opcionesLista").value;
              campo.options = opcionesText.split("\n").map(o => o.trim()).filter(o => o);
              if (campo.options.length === 0) {
                mensaje.textContent = "Los campos de tipo lista desplegable deben tener al menos una opci√≥n.";
                return;
              }
              break;
            default:
              campo.type = "text";
          }
          campos.push(campo);
        }

        try {
          const res = await fetch(urlWebApp, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              action: "guardarFormulario",
              id: contenidoEditor.dataset.formId,
              titulo: nuevoTitulo,
              estructura: campos,
            }),
          });
          const json = await res.json();
          if (json.status === "ok") {
            mensaje.style.color = "green";
            mensaje.textContent = "Formulario guardado correctamente.";
            // Recargar lista para actualizar t√≠tulos etc.
            cargarFormularios();
          } else {
            mensaje.style.color = "red";
            mensaje.textContent = "Error al guardar formulario: " + json.message;
          }
        } catch (e) {
          console.error(e);
          mensaje.style.color = "red";
          mensaje.textContent = "Error al conectar con el servidor.";
        }
      };
    }

    async function eliminarFormulario(id) {
      mensaje.textContent = "";
      if (!id) return;
      try {
        const res = await fetch(urlWebApp, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ action: "eliminarFormulario", id }),
        });
        const json = await res.json();
        if (json.status === "ok") {
          mensaje.style.color = "green";
          mensaje.textContent = "Formulario eliminado correctamente.";
          cargarFormularios();
          contenidoEditor.innerHTML = "<p>Selecciona un formulario para editarlo.</p>";
        } else {
          mensaje.style.color = "red";
          mensaje.textContent = "Error al eliminar formulario: " + json.message;
        }
      } catch (e) {
        console.error(e);
        mensaje.style.color = "red";
        mensaje.textContent = "Error al conectar con el servidor.";
      }
    }

    // Inicializamos
    cargarFormularios();
  </script>
</body>
</html>
